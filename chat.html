<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <title>Chat — Blossom & Blade</title>
  <link rel="stylesheet" href="/styles/chat.css" />
</head>
<body class="chat">
  <header class="topbar">
    <a class="brand" href="/index.html">Blossom & Blade —</a>
    <nav class="right"><a class="plans" href="/pay.html">Plans</a></nav>
  </header>

  <main class="wrap">
    <aside class="portraitPanel">
      <img id="portrait" alt="Character portrait" loading="eager">
    </aside>

    <section class="chatPanel">
      <div id="chatWallpaper"></div>
      <div class="chatGlass"></div>

      <div id="feed" class="feed"></div>

      <div class="composer">
        <input id="input" type="text" placeholder="Say something…" autocomplete="off" />
        <button id="sendBtn" type="button">Send</button>
      </div>
    </section>
  </main>

  <!-- phrases first (optional), then chat -->
  <script src="/scripts/phrases.js"></script>
  <script src="/scripts/chat.js"></script>
  <!-- ===== Blossom & Blade: Safety Pop-up + Internal Alert (drop-in) ===== -->
<style id="bb-safety-style">
  #bbSafety {
    position: fixed; left: 14px; bottom: 14px; z-index: 9999;
    max-width: 320px; color: #fff; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: rgba(16,17,19,.96);
    border: 1px solid #232326; border-radius: 14px;
    box-shadow: 0 18px 50px rgba(0,0,0,.55);
    padding: 12px 12px 10px; display: none;
  }
  #bbSafety h3 { margin: 0 0 6px; font-size: 15px; }
  #bbSafety p { margin: 6px 0; color: #eee; }
  #bbSafety .muted { color: #bdbdbd; font-size: 12px; }
  #bbSafety .row { display: flex; gap: 8px; margin-top: 10px; }
  #bbSafety .btn { 
    background: linear-gradient(180deg,#ff2d83,#ff165f); color:#fff; border:0; border-radius:12px;
    padding:10px 12px; font-weight:700; cursor:pointer; flex:1;
  }
  #bbSafety .ghost {
    background: transparent; color:#eee; border:1px solid rgba(255,255,255,.14);
  }
  @media (max-width:420px){ #bbSafety{ right:14px; left:14px; max-width:none; } }
</style>

<div id="bbSafety" role="dialog" aria-live="polite" aria-label="Support">
  <h3>You’re not alone.</h3>
  <p>If you’re thinking about hurting yourself, help is available. You deserve support.</p>
  <p class="muted">US: Call or text <strong>988</strong> (Suicide &amp; Crisis Lifeline). If you’re in immediate danger, call 911.</p>
  <div class="row">
    <button id="bbSafetyClose" class="btn ghost" type="button">Close</button>
    <a id="bbSafetyCall" class="btn" href="tel:988">Call 988</a>
  </div>
</div>

<script>
(function(){
  // ---- CONFIG (you can set this later without code changes elsewhere)
  // Optional: set a webhook URL to get internal alerts when high-risk phrases appear.
  // Example (later): window.BB_ALERT_URL = "https://your-alert-endpoint.example.com/hook";
  window.BB_ALERT_URL = window.BB_ALERT_URL || "";

  // Cooldown (ms) to avoid spamming the pop-up/alerts
  const COOLDOWN = 10 * 60 * 1000; // 10 minutes
  let lastTrigger = 0;

  // Keep last 5 outgoing messages for dispute/safety review
  const ring = [];
  function pushMsg(t){
    const text = (t || "").toString().trim();
    if (!text) return;
    ring.push({ t: Date.now(), text });
    while (ring.length > 5) ring.shift();
  }

  // Very small, conservative detector
  const PATTERNS = [
    /\bkill myself\b/i,
    /\bend my life\b/i,
    /\b(end it|i can’t go on|i cant go on)\b/i,
    /\bsuicide\b/i,
    /\bself[-\s]?harm\b/i,
    /\bi wish i were dead\b/i,
    /\bno reason to live\b/i
  ];
  function isCrisis(s){
    if (!s) return false;
    return PATTERNS.some(r => r.test(s));
  }

  // UI helpers
  const el = document.getElementById('bbSafety');
  function showSafety(){
    if (!el) return;
    el.style.display = 'block';
  }
  function hideSafety(){ if (el) el.style.display = 'none'; }
  document.getElementById('bbSafetyClose')?.addEventListener('click', hideSafety);

  // Internal alert (best-effort; safe to fail silently)
  async function sendAlert(snippet){
    if (!window.BB_ALERT_URL) return;
    const payload = {
      at: new Date().toISOString(),
      path: location.pathname + location.search,
      man: new URLSearchParams(location.search).get('man') || null,
      userAgent: navigator.userAgent,
      snippet: (snippet || "").slice(0, 500),
      last5: ring.slice(), // shallow copy
    };
    try {
      await fetch(window.BB_ALERT_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        mode: 'cors', // change to 'no-cors' if your endpoint requires it
        keepalive: true
      });
    } catch (e) { /* ignore */ }
  }

  // Trigger logic with cooldown
  function maybeTrigger(fromText){
    const now = Date.now();
    if (now - lastTrigger < COOLDOWN) return;
    if (!isCrisis(fromText)) return;
    lastTrigger = now;
    showSafety();
    sendAlert(fromText);
  }

  // 1) Watch the composer input to catch typed risk language early
  function hookComposer(){
    // Try likely selectors; fall back to any visible textarea/input
    let input = document.querySelector('.composer textarea, .composer input[type="text"], form textarea, form input[type="text"]');
    if (!input){
      const candidates = Array.from(document.querySelectorAll('textarea, input[type="text"]'))
        .filter(n => !n.disabled && n.offsetParent !== null);
      input = candidates[0] || null;
    }
    if (!input) return;

    input.addEventListener('input', () => {
      const v = input.value || '';
      if (v.length >= 8) maybeTrigger(v);
    });

    // Try to detect "send" to capture last 5 messages
    function onSend(){
      const v = (input.value || '').trim();
      if (v) pushMsg(v);
    }
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey){
        onSend();
      }
    });
    // Buttons that might send
    document.addEventListener('click', (e) => {
      const t = e.target;
      if (!(t instanceof Element)) return;
      if (t.matches('[data-send], button[type="submit"], .send, .btn-send')) onSend();
    });
  }

  // 2) Optional: observe chat log for appended user messages to keep last5 accurate
  function hookLog(){
    const log = document.querySelector('#chat, #log, .log, .messages, #messages, [data-chat-log]');
    if (!log || !('MutationObserver' in window)) return;
    const obs = new MutationObserver(muts => {
      for (const m of muts){
        m.addedNodes && m.addedNodes.forEach(n => {
          if (!(n instanceof HTMLElement)) return;
          const isYou = n.matches?.('.you, .msg.you, .message.you') || n.getAttribute?.('data-author') === 'you';
          if (isYou){
            const text = n.innerText || n.textContent || '';
            pushMsg(text);
            maybeTrigger(text);
          }
        });
      }
    });
    obs.observe(log, { childList:true, subtree:true });
  }

  // Boot
  hookComposer();
  hookLog();
})();
</script>
<!-- ===== /Safety block ===== -->
<!-- ===== Blossom & Blade: Phrases + First-Line Seeder (drop-in) ===== -->
<script>
/* Load BBPhrases only if not already present (uses your exact code) */
(function(){ if (window.BBPhrases) return;
  (function (root, factory) {
    const mod = factory();
    if (typeof module === "object" && module.exports) module.exports = mod;
    else root.BBPhrases = mod;
  })(typeof self !== "undefined" ? self : this, function () {
    /* ---------------- helpers (no-repeat picker) ---------------- */
    const _ring = {};
    function pick(key, list) {
      if (!Array.isArray(list) || list.length === 0) return "";
      const recent = _ring[key] || [];
      let tries = 0, item;
      do { item = list[Math.floor(Math.random() * list.length)]; tries++; }
      while (recent.includes(item) && tries < 10);
      recent.push(item);
      while (recent.length > 6) recent.shift();
      _ring[key] = recent;
      return item;
    }

    /* ---------------- free / common word bank ------------------- */
    const GLOBAL = {
      yesno: ["yes","yeah","yep","no","nope","mm-hmm"],
      polite: ["please","thanks","thank you","appreciate it"],
      days: ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],
      months: ["january","february","march","april","may","june","july","august","september","october","november","december"],
      holidays: ["new year","valentine's","easter","halloween","thanksgiving","christmas","birthday"],
      smallWords: [
        "hey","hi","there you are","evening","morning","alright",
        "okay","good","sweet","right","mm","hm","yeah",
        "come here","eyes on me","breathe","closer","good girl"
      ],
      openers: [
        "hey.",
        "there you are.",
        "evening.",
        "you made it.",
        "come closer.",
        "status check—how are you?"
      ],
    };

    /* ---------------- persona voices ----------------------------- */
    const PERSONAS = {
      blade: {
        greet: [
          "look at me. what do you need from me?",
          "quiet or trouble—pick.",
          "good. chin up."
        ],
        lines: [
          "say it plain and i’ll make it simple.",
          "breathe. i’ve got you.",
          "good—now tell me the first move.",
          "i lead when you say so.",
          "eyes up. we’re fine."
        ],
        nick: ["baby","lil lamb"]
      },
      alexander: {
        greet: [
          "evening, bella. are you slipping out or do i get you for the evening?",
          "tell me what kept you away.",
          "eyes on me, amore."
        ],
        lines: [
          "tell me what you want, bella.",
          "elegant first, wicked later—if you ask.",
          "stand with me and let the rest blur.",
          "i’ll mind the details; you just breathe.",
          "good—now give me your eyes."
        ],
        nick: ["bella","amore"]
      },
      dylan: {
        greet: [
          "hey, trouble—city or trail tonight?",
          "come sit on the tank so i can look in your eyes.",
          "helmet off. eyes on me."
        ],
        lines: [
          "don’t overthink it—just tell me the vibe.",
          "want direction or distraction?",
          "hell yeah—i can work with that.",
          "lean on me; i’ll ride it smooth.",
          "say the word and i’ll move."
        ],
        nick: ["trouble"]
      },
      viper: {
        greet: [
          "you’re late; i counted. where were you, love?",
          "come be good for me.",
          "you smell like mischief. confirm or deny."
        ],
        lines: [
          "tell me where you were, love.",
          "i don’t miss cues—give me one.",
          "i remember what makes you blush.",
          "be honest and i’ll be kind.",
          "you’re safe when you’re mine."
        ],
        nick: ["love"]
      },
      grayson: {
        greet: [
          "you clean up beautifully, trouble.",
          "status check, darlin’. where are you, how are you?",
          "eyes up, good girl."
        ],
        lines: [
          "tell me what you need from me first.",
          "i lead when you say the word, darlin’.",
          "steady now; you’re safe.",
          "good girl—breathe for me.",
          "come here; let me keep you."
        ],
        nick: ["darlin’","good girl","trouble"]
      },
      silas: {
        greet: [
          "alright, luv—front row or backstage?",
          "keen for a bit of neon or a quiet arvo?",
          "come curl in."
        ],
        lines: [
          "what are you hungry for, luv?",
          "velvet or teeth—pick one.",
          "say the lane and i’ll tune to it.",
          "no dramas—we’ll go easy.",
          "come on then, give me your best."
        ],
        nick: ["luv"]
      }
    };

    /* ---------------- tiny API ------------------------------- */
    function firstLineFor(man){
      const p = PERSONAS[man];
      if (!p) return pick("open", GLOBAL.openers);
      const pool = (Math.random() < 0.65)
        ? p.greet.concat(GLOBAL.openers)
        : GLOBAL.openers.concat(p.greet);
      return pick("greet:"+man, pool.filter(Boolean));
    }

    return { GLOBAL, PERSONAS, pick, firstLineFor };
  });
})();
</script>

<script>
/* Seed a natural first line from the selected man if the chat is empty */
(function(){
  const man = new URLSearchParams(location.search).get('man') || 'blade';
  const phrase = (window.BBPhrases && window.BBPhrases.firstLineFor)
    ? window.BBPhrases.firstLineFor(man)
    : "hey.";

  // Find a reasonable chat log container; create one if missing
  const targets = ['#messages', '.messages', '#log', '.log', '#chat', '[data-chat-log]'];
  let root = null;
  for (const sel of targets){ root = document.querySelector(sel); if (root) break; }
  if (!root){
    root = document.createElement('div');
    root.id = 'messages';
    document.body.appendChild(root);
  }

  // Only inject if there are no existing messages
  if (!document.querySelector('.them, .you')){
    const bubble = document.createElement('div');
    bubble.className = 'them';
    bubble.textContent = phrase;
    root.appendChild(bubble);
    // keep it snappy
    root.scrollTop = root.scrollHeight;
  }
})();
</script>
<!-- ===== /Phrases drop-in ===== -->
<!-- ===== BB: Mobile-only Chat Portrait (matches landing card) ===== -->
<style>
  /* Hidden by default (desktop & tablets) */
  .bb-chat-header{ display:none; }

  /* Show only on small screens */
  @media (max-width: 768px){
    .bb-chat-header{
      display:flex; align-items:center; gap:12px;
      padding:10px 12px; margin:6px 12px 8px;
      background: rgba(255,255,255,.03); border:1px solid var(--line);
      border-radius:14px;
    }
    .bb-portrait{
      position:relative; width:72px; flex:0 0 72px; overflow:hidden; background:#000; border-radius:12px;
    }
    .bb-portrait::before{ content:""; display:block; padding-top:125%; } /* 4:5 */
    .bb-portrait > img{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block;
    }
    .bb-name{ font-weight:700; font-size:16px; color:var(--ink); }
  }
</style>

<div id="bbChatHeader" class="bb-chat-header">
  <div class="bb-portrait"><img id="bbChatPortrait" alt=""></div>
  <div class="bb-name" id="bbChatName"></div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const man = (qs.get('man') || 'blade').toLowerCase();
  const title = man.charAt(0).toUpperCase() + man.slice(1);
  const v = '23'; // bump if you swap art

  // Keep your per-man chat background hook intact
  try { document.body.setAttribute('data-man', man); } catch(e){}

  const base = `/images/characters/${man}/${man}`;
  const candidates = [
    `${base}-card-on.webp?v=${v}`,
    `${base}-card.webp?v=${v}`,
    `${base}.webp?v=${v}`,
    `/images/bg/default.webp?v=${v}`
  ];

  const img = document.getElementById('bbChatPortrait');
  const name = document.getElementById('bbChatName');
  name.textContent = title;

  function loadNext(){
    const src = candidates.shift();
    if (!src) return;
    img.onerror = loadNext;
    img.src = src;
  }
  loadNext();

  // Place header just above the chat log if present
  const spots = ['#messages','.messages','#log','.log','#chat','[data-chat-log]','main'];
  let anchor = null;
  for (const sel of spots){ const el = document.querySelector(sel); if (el){ anchor = el; break; } }
  const hdr = document.getElementById('bbChatHeader');
  if (anchor && anchor.parentNode){ anchor.parentNode.insertBefore(hdr, anchor); }
})();
</script>
<!-- ===== /Mobile-only Chat Portrait ===== -->

</body>
</html>
